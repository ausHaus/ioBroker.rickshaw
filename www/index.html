<!doctype html>

<link rel="stylesheet" href="rickshaw.min.css">

<script src="jquery-1.11.1.min.js"></script>
<script src="../socket.io/socket.io.js"></script>
<script src="d3.min.js"></script>
<script src="rickshaw.min.js"></script>

<style>
    #chart_container {
        position: relative;
        font-family: Arial, Helvetica, sans-serif;
    }
    #chart {
        position: relative;
        left: 40px;
    }
    #y_axis {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 40px;
    }
</style>

<h3 id="name"></h3>

<div id="chart_container">
    <div id="y_axis"></div>
    <div id="chart"></div>
</div>

<script>
    var id = 'hm-rpc.0.KEQ0175982:1.TEMPERATURE';


    var socket = io.connect();

    var graph;
    var data = [];

    socket.on('stateChange', function (changeId, state) {
        if (changeId === id) {
            data.push({x: state.ts, y: state.val});
            graph.update();
            console.log('update!');
        }
    });

    socket.emit('getObject', id, function (err, res) {
        var name = id;
        var unit = '';

        if (!err && res.common) {
            name = res.common.name;
            unit = res.common.unit;
        }


        $('#name').html(name);

        socket.emit('getStateHistory', id, function (err, res) {
            console.log(err, res);




            for (var i = res.length - 1; i >= 0; i--) {
                data.push({x: res[i].ts, y: res[i].val});
            }

            console.log(data);

            graph = new Rickshaw.Graph( {
                element: document.querySelector("#chart"),
                renderer: 'line',
                width: 800,
                height: 400,
                series: [{
                    name: name,
                    color: 'steelblue',
                    data: data
                }]
            });

            var x_axis = new Rickshaw.Graph.Axis.Time({
                graph: graph,
                timeFixture: new Rickshaw.Fixtures.Time.Local()
            });

            var y_axis = new Rickshaw.Graph.Axis.Y({
                graph: graph,
                orientation: 'left',
                tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
                element: document.getElementById('y_axis')
            });


            var hoverDetail = new Rickshaw.Graph.HoverDetail({
                graph: graph,
                formatter: function(series, x, y) {
                    var date = '<span class="date">' + new Date(x * 1000).toLocaleString() + '</span>';
                    var swatch = '<span class="detail_swatch" style="background-color: ' + series.color + '"></span>';
                    var content = swatch + series.name + ": " + y.toFixed(1) + unit + '<br>' + date;
                    return content;
                }
            });




            graph.render();

        });

    });




</script>